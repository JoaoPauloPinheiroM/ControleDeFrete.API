@page "/motoristas"
@layout MainLayout
@inject MotoristaApi MotoristaApi

<div class="page-header">
    <div>
        <p class="eyebrow">Operação</p>
        <h1 class="page-title">Motoristas</h1>
    </div>
    <div class="header-actions">
        <button class="btn ghost" @onclick="LoadMotoristas" disabled="@IsBusy">Recarregar</button>
        <button class="btn" @onclick="ToggleNovoMotorista">@((ShowNovoMotorista ? "Fechar" : "Novo motorista"))</button>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace( Error ))
{
    <div class="alert error">@Error</div>
}
@if (!string.IsNullOrWhiteSpace( Info ))
{
    <div class="alert success">@Info</div>
}

<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-label">Total</div>
        <div class="metric-value">@MotoristasList.Count</div>
        <div class="metric-note">Cadastros de motoristas</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Ativos</div>
        <div class="metric-value">@TotalAtivos</div>
        <div class="metric-note">Disponíveis para escala</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Inativos</div>
        <div class="metric-value">@TotalInativos</div>
        <div class="metric-note">Aguardando ativação</div>
    </div>
</div>

@if (ShowNovoMotorista)
{
    <section class="panel">
        <header>Novo motorista</header>
        <EditForm Model="NewMotorista" OnValidSubmit="CreateMotorista">
            <DataAnnotationsValidator />
            <div class="form-grid labeled">
                <label class="field">
                    <span>Nome</span>
                    <InputText @bind-Value="NewMotorista.Nome" placeholder="Nome completo" />
                </label>
                <label class="field">
                    <span>Documento</span>
                    <InputText @bind-Value="NewMotorista.Documento" placeholder="CPF/CNPJ" />
                </label>
                <label class="field">
                    <span>CNH</span>
                    <InputText @bind-Value="NewMotorista.Cnh" placeholder="Carteira de Habilitação" />
                </label>
                <label class="field">
                    <span>Logradouro</span>
                    <InputText @bind-Value="NewMotorista.Logradouro" placeholder="Rua/Av" />
                </label>
                <label class="field">
                    <span>Cidade</span>
                    <InputText @bind-Value="NewMotorista.Cidade" placeholder="Nome da cidade" />
                </label>
                <label class="field short">
                    <span>UF</span>
                    <InputText @bind-Value="NewMotorista.Estado" placeholder="UF" />
                </label>
            </div>
            <div class="toolbar">
                <button class="btn" type="submit" disabled="@IsBusy">Salvar motorista</button>
                <button class="btn ghost" type="button" @onclick="ToggleNovoMotorista">Cancelar</button>
            </div>
        </EditForm>
    </section>
}

<section class="panel">
    <header>Motoristas</header>
    <div class="filters">
        <InputText @bind-Value="SearchTerm" placeholder="Buscar por nome, documento ou cidade" />
        <InputSelect @bind-Value="StatusFilter">
            <option value="all">Todos</option>
            <option value="active">Ativos</option>
            <option value="inactive">Inativos</option>
        </InputSelect>
    </div>
    @if (!FilteredMotoristas.Any())
    {
        <p class="muted-text">Nenhum motorista encontrado para o filtro.</p>
    }
    else
    {
        <div class="table-wrapper">
            <table class="data-table modern">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Documento</th>
                        <th>CNH</th>
                        <th>Endereço</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var motorista in FilteredMotoristas)
                    {
                        <tr>
                            <td class="strong">@motorista.Nome</td>
                            <td>@motorista.Documento</td>
                            <td>@motorista.Cnh</td>
                            <td>@motorista.Endereco</td>
                            <td>
                                <span class="status-chip @(motorista.Ativo ? "ok" : "warn")">@(motorista.Ativo ? "Ativo" : "Inativo")</span>
                            </td>
                            <td class="actions inline-buttons">
                                <button class="btn small" @onclick="() => StartEdit(motorista.Documento)">Editar</button>
                                <button class="btn outline small" @onclick="() => ToggleStatus(motorista.Documento)" disabled="@IsBusy">
                                    @(motorista.Ativo ? "Inativar" : "Ativar")
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</section>

@if (!string.IsNullOrWhiteSpace( DocumentoEditando ))
{
    <section class="panel muted">
        <header>Editar motorista (@DocumentoEditando)</header>
        <EditForm Model="EditMotorista" OnValidSubmit="SalvarEdicao">
            <div class="form-grid">
                <InputText @bind-Value="EditMotorista.Nome" placeholder="Nome" />
                <InputText @bind-Value="EditMotorista.NovoDocumento" placeholder="Novo documento" />
                <InputText @bind-Value="EditMotorista.Cnh" placeholder="CNH" />
                <InputText @bind-Value="EditMotorista.Logradouro" placeholder="Logradouro" />
                <InputText @bind-Value="EditMotorista.Cidade" placeholder="Cidade" />
                <InputText @bind-Value="EditMotorista.Estado" placeholder="UF" />
            </div>
            <div class="toolbar">
                <button class="btn" type="submit" disabled="@IsBusy">Salvar</button>
                <button class="btn ghost" type="button" @onclick="CancelarEdicao">Cancelar</button>
            </div>
        </EditForm>
    </section>
}

@code {
    private List<MotoristaResponse> MotoristasList { get; set; } = new();
    private MotoristaCreate NewMotorista { get; set; } = new();
    private MotoristaUpdate EditMotorista { get; set; } = new();
    private string? DocumentoEditando { get; set; }
    private bool IsBusy { get; set; }
    private string? Error { get; set; }
    private string? Info { get; set; }
    private string SearchTerm { get; set; } = string.Empty;
    private string StatusFilter { get; set; } = "all";
    private bool ShowNovoMotorista { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadMotoristas();
    }
    
    private void ToggleNovoMotorista()
    {
        ShowNovoMotorista = !ShowNovoMotorista;
        if (!ShowNovoMotorista) NewMotorista = new();
    }

    private async Task LoadMotoristas()
    {
        IsBusy = true;
        Error = null;
        Info = null;

        var (data, err) = await MotoristaApi.GetAllAsync();
        if (err is not null)
        {
            Error = err;
        }
        else if (data is not null)
        {
            MotoristasList = data.OrderBy( m => m.Nome ).ToList();
        }

        IsBusy = false;
    }

    private IEnumerable<MotoristaResponse> FilteredMotoristas => MotoristasList
        .Where( m => string.IsNullOrWhiteSpace( SearchTerm ) ||
                     m.Nome.Contains( SearchTerm , StringComparison.OrdinalIgnoreCase ) ||
                     m.Documento.Contains( SearchTerm , StringComparison.OrdinalIgnoreCase ) ||
                     m.Endereco.Contains( SearchTerm , StringComparison.OrdinalIgnoreCase ) )
        .Where( m => StatusFilter switch
        {
            "active" => m.Ativo,
            "inactive" => !m.Ativo,
            _ => true
        } );

    private int TotalAtivos => MotoristasList.Count( m => m.Ativo );
    private int TotalInativos => MotoristasList.Count( m => !m.Ativo );

    private async Task CreateMotorista()
    {
        IsBusy = true;
        Error = null;
        Info = null;

        var err = await MotoristaApi.CreateAsync( NewMotorista );
        if (err is not null)
        {
            Error = err;
        }
        else
        {
            Info = "Motorista criado.";
            NewMotorista = new();
            await LoadMotoristas();
        }

        IsBusy = false;
    }

    private void StartEdit( string documento )
    {
        DocumentoEditando = documento;
        EditMotorista = new();
        Info = null;
        Error = null;
    }

    private async Task SalvarEdicao()
    {
        if (string.IsNullOrWhiteSpace( DocumentoEditando )) return;

        IsBusy = true;
        Error = null;
        Info = null;

        var err = await MotoristaApi.EditAsync( DocumentoEditando , EditMotorista );
        if (err is not null)
        {
            Error = err;
        }
        else
        {
            Info = "Motorista atualizado.";
            DocumentoEditando = null;
            EditMotorista = new();
            await LoadMotoristas();
        }

        IsBusy = false;
    }

    private async Task ToggleStatus( string documento )
    {
        IsBusy = true;
        Error = null;
        Info = null;

        var err = await MotoristaApi.ToggleStatusAsync( documento );
        if (err is not null)
        {
            Error = err;
        }
        else
        {
            Info = "Status atualizado.";
            await LoadMotoristas();
        }

        IsBusy = false;
    }

    private void CancelarEdicao()
    {
        DocumentoEditando = null;
        EditMotorista = new();
    }
}
