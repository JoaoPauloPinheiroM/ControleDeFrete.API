@page "/clientes"
@layout MainLayout
@inject ClienteApi ClienteApi

<div class="page-header">
    <div>
        <p class="eyebrow">Cadastro base</p>
        <h1 class="page-title">Clientes</h1>
    </div>
    <div class="header-actions">
        <button class="btn ghost" @onclick="LoadClientes" disabled="@IsBusy">Recarregar</button>
        <button class="btn" @onclick="ToggleNovoCliente">@((ShowNovoCliente ? "Fechar" : "Novo cliente"))</button>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace( Error ))
{
    <div class="alert error">@Error</div>
}
@if (!string.IsNullOrWhiteSpace( Info ))
{
    <div class="alert success">@Info</div>
}

<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-label">Total</div>
        <div class="metric-value">@ClientesList.Count</div>
        <div class="metric-note">Clientes cadastrados</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Ativos</div>
        <div class="metric-value">@TotalAtivos</div>
        <div class="metric-note">Disponíveis para fretes</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Inativos</div>
        <div class="metric-value">@TotalInativos</div>
        <div class="metric-note">Pendentes de ativação</div>
    </div>
</div>

@if (ShowNovoCliente)
{
    <section class="panel">
        <header>Novo cliente</header>
        <EditForm Model="NewCliente" OnValidSubmit="CreateCliente">
            <DataAnnotationsValidator />
            <div class="form-grid labeled">
                <label class="field">
                    <span>Nome</span>
                    <InputText @bind-Value="NewCliente.Nome" placeholder="Nome completo" />
                </label>
                <label class="field">
                    <span>Documento</span>
                    <InputText @bind-Value="NewCliente.Documento" placeholder="CPF/CNPJ" />
                </label>
                <label class="field">
                    <span>Logradouro</span>
                    <InputText @bind-Value="NewCliente.Logradouro" placeholder="Logradouro" />
                </label>
                <label class="field">
                    <span>Cidade</span>
                    <InputText @bind-Value="NewCliente.Cidade" placeholder="Cidade" />
                </label>
                <label class="field short">
                    <span>UF</span>
                    <InputText @bind-Value="NewCliente.Estado" placeholder="UF" />
                </label>
            </div>
            <div class="toolbar">
                <button class="btn" type="submit" disabled="@IsBusy">Salvar cliente</button>
                <button class="btn ghost" type="button" @onclick="ToggleNovoCliente">Cancelar</button>
            </div>
        </EditForm>
    </section>
}

<section class="panel">
    <header>Clientes</header>
    <div class="filters">
        <InputText @bind-Value="SearchTerm" placeholder="Buscar por nome, documento ou cidade" />
        <InputSelect @bind-Value="StatusFilter">
            <option value="all">Todos</option>
            <option value="active">Ativos</option>
            <option value="inactive">Inativos</option>
        </InputSelect>
    </div>
    @if (!FilteredClientes.Any())
    {
        <p class="muted-text">Nenhum cliente encontrado para o filtro.</p>
    }
    else
    {
        <div class="table-wrapper">
            <table class="data-table modern">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Documento</th>
                        <th>Endereço</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cliente in FilteredClientes)
                    {
                        <tr>
                            <td class="strong">@cliente.Nome</td>
                            <td>@cliente.Documento</td>
                            <td>@cliente.Endereco</td>
                            <td>
                                <span class="status-chip @(cliente.Ativo ? "ok" : "warn")">@(cliente.Ativo ? "Ativo" : "Inativo")</span>
                            </td>
                            <td class="actions inline-buttons">
                                <button class="btn small" @onclick="() => StartEdit(cliente.Documento)">Editar</button>
                                <button class="btn outline small" @onclick="() => ToggleStatus(cliente.Documento)" disabled="@IsBusy">
                                    @(cliente.Ativo ? "Inativar" : "Ativar")
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</section>

@if (!string.IsNullOrWhiteSpace( DocumentoEditando ))
{
    <section class="panel muted">
        <header>Editar cliente (@DocumentoEditando)</header>
        <EditForm Model="EditCliente" OnValidSubmit="SalvarEdicao">
            <div class="form-grid">
                <InputText @bind-Value="EditCliente.Nome" placeholder="Novo nome" />
                <InputText @bind-Value="EditCliente.NovoDocumento" placeholder="Novo documento" />
                <InputText @bind-Value="EditCliente.Logradouro" placeholder="Logradouro" />
                <InputText @bind-Value="EditCliente.Cidade" placeholder="Cidade" />
                <InputText @bind-Value="EditCliente.Estado" placeholder="UF" />
            </div>
            <div class="toolbar">
                <button class="btn" type="submit" disabled="@IsBusy">Salvar</button>
                <button class="btn ghost" type="button" @onclick="CancelarEdicao">Cancelar</button>
            </div>
        </EditForm>
    </section>
}

@code {
    private List<ClienteResponse> ClientesList { get; set; } = new();
    private ClienteCreate NewCliente { get; set; } = new();
    private ClienteUpdate EditCliente { get; set; } = new();
    private string? DocumentoEditando { get; set; }
    private bool IsBusy { get; set; }
    private string? Error { get; set; }
    private string? Info { get; set; }
    private string SearchTerm { get; set; } = string.Empty;
    private string StatusFilter { get; set; } = "all";
    private bool ShowNovoCliente { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadClientes();
    }
    
    private void ToggleNovoCliente()
    {
        ShowNovoCliente = !ShowNovoCliente;
        if (!ShowNovoCliente) NewCliente = new();
    }

    private async Task LoadClientes()
    {
        IsBusy = true;
        Error = null;
        Info = null;

        var (data, err) = await ClienteApi.GetAllAsync();
        if (err is not null)
        {
            Error = err;
        }
        else if (data is not null)
        {
            ClientesList = data.OrderBy( c => c.Nome ).ToList();
        }

        IsBusy = false;
    }

    private IEnumerable<ClienteResponse> FilteredClientes => ClientesList
        .Where( c => string.IsNullOrWhiteSpace( SearchTerm ) ||
                     c.Nome.Contains( SearchTerm , StringComparison.OrdinalIgnoreCase ) ||
                     c.Documento.Contains( SearchTerm , StringComparison.OrdinalIgnoreCase ) ||
                     c.Endereco.Contains( SearchTerm , StringComparison.OrdinalIgnoreCase ) )
        .Where( c => StatusFilter switch
        {
            "active" => c.Ativo,
            "inactive" => !c.Ativo,
            _ => true
        } );

    private int TotalAtivos => ClientesList.Count( c => c.Ativo );
    private int TotalInativos => ClientesList.Count( c => !c.Ativo );

    private async Task CreateCliente()
    {
        IsBusy = true;
        Error = null;
        Info = null;

        var err = await ClienteApi.CreateAsync( NewCliente );
        if (err is not null)
        {
            Error = err;
        }
        else
        {
            Info = "Cliente criado com sucesso.";
            NewCliente = new();
            await LoadClientes();
        }

        IsBusy = false;
    }

    private void StartEdit( string documento )
    {
        DocumentoEditando = documento;
        EditCliente = new();
        Info = null;
        Error = null;
    }

    private async Task SalvarEdicao()
    {
        if (string.IsNullOrWhiteSpace( DocumentoEditando )) return;

        IsBusy = true;
        Error = null;
        Info = null;

        var err = await ClienteApi.EditAsync( DocumentoEditando , EditCliente );
        if (err is not null)
        {
            Error = err;
        }
        else
        {
            Info = "Cliente atualizado.";
            DocumentoEditando = null;
            EditCliente = new();
            await LoadClientes();
        }

        IsBusy = false;
    }

    private async Task ToggleStatus( string documento )
    {
        IsBusy = true;
        Error = null;
        Info = null;

        var err = await ClienteApi.ToggleStatusAsync( documento );
        if (err is not null)
        {
            Error = err;
        }
        else
        {
            Info = "Status atualizado.";
            await LoadClientes();
        }

        IsBusy = false;
    }

    private void CancelarEdicao()
    {
        DocumentoEditando = null;
        EditCliente = new();
    }
}
